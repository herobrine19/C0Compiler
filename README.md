# 于C0文法的小型编译器实现

[TOC]

## 一、C0文法

符号含义

| EBNF(扩展巴科斯范式)元符号 | 含义                  |
| -------------------------- | --------------------- |
| ::=                        | 定义为                |
| \|                         | 或                    |
| { }                        | 含0次在内任意多次重复 |
| [ ]                        | 含0次和1次            |
| < >                        | 非终结符              |
| ( )                        | 括号内看作一项        |

具体文法

| 非终结符               | 右部                                                         |
| ---------------------- | ------------------------------------------------------------ |
| <加法运算符>           | + \| -                                                       |
| <乘法运算符>           | * \| /                                                       |
| <关系运算符>           | < \| <= \| > \| >= \| != \| ==                               |
| <字母>                 | _\|a\|...\|z\|A\|...\|Z                                      |
| <数字>                 | 0\|<非零数字>                                                |
| <非零数字>             | 1\|...\|9                                                    |
| <字符>                 | '<加法运算符>'\|'<乘法运算符>'\|'<字母>'\|'<数字>'           |
| <字符串>               | "{十进制编码为32，33，35-126的ASCII字符}"                    |
| <程序>                 | [<常量说明>] [<变量说明>] {<有返回值函数定义>\|<无返回值函数定义>}<主函数> |
| <常量说明>             | const <常量定义> ; {const <常量定义> ;}                      |
| <常量定义>             | int <标识符> = <整数> {,int <标识符> = <整数>} \|char <标识符> = <字符> {,char <标识符> = <字符>} |
| <无符号整数>           | <非零数字> {<数字>}                                          |
| <整数>                 | [ +\|- ] <无符号整数> \| 0                                   |
| <标识符>               | <字母> {<字母> \| <数字>}                                    |
| <声明头部>             | int <标识符> \| char <标识符>                                |
| <变量说明>             | <变量定义> ; {<变量定义>;}                                   |
| <变量定义>             | <类型标识符> (<标识符>\|<标识符>'['<无符号整数>']'){,(<标识符>\|<标识符>'['<无符号整数>']')}   *举例：int a1,ax[2],ax3,ax[4]* |
| <常量>                 | <整数>\|<字符>                                               |
| <类型标识符>           | int\|char                                                    |
| <有返回值函数定义>     | <声明头部> '(' <参数> ')' '{' <复合语句> '}'  *举例：int function(int a,int b){xxxxx}* |
| <无返回值函数定义>     | void <标识符> '(' <参数> ')' '{' <复合语句> '}'              |
| <复合语句>             | [<常量说明>] [<变量说明>] <语句列>                           |
| <参数>                 | <参数表>                                                     |
| <参数表>               | <类型标识符> <标识符> {, <类型标识符> <标识符>} \| <空>      |
| <主函数>               | void main '(' ')' '{' <复合语句> '}'                         |
| <表达式>               | [ + \| - ] <项> {<加法运算符> <项>} *例：a+b, a\*b+c\*d, a+(b+c)* |
| <项>                   | <因子> {<乘法运算符><因子>} *例：a\*b, a, (a+b)\*c, a/c*     |
| <因子>                 | <标识符> \| <标识符> '[' <表达式> ']' \| <整数> \| <字符> \| <有返回值函数调用语句> \| '(' <表达式> ')' *例：(a+b), call(a)* |
| <语句>                 | <条件语句>\|<循环语句>\|'{' <语句列> '}' \| <有返回值函数调用语句>; \| <无返回值函数调用语句>; \| <赋值语句>; \| <读语句>; \| <写语句>; \| <空>; \| <情况语句> \| <返回语句>; |
| <赋值语句>             | <标识符> = <表达式> \| <标识符> '[' <表达式> ']' = <表达式>  |
| <条件语句>             | if '(' <条件> ')' <语句> [else <语句>]                       |
| <条件>                 | <表达式> <关系运算符> <表达式> \| <表达式>                   |
| <循环语句>             | while '(' <条件> ')' <语句>                                  |
| <情况语句>             | switch '(' <表达式> ')' '{' <情况表> '}'do                   |
| <情况表>               | <情况子语句> {<情况子语句>}                                  |
| <情况子语句>           | case <常量> : <语句>                                         |
| <有返回值函数调用语句> | <标识符> '(' <值参数表> ')'                                  |
| <无返回值函数调用语句> | <标识符> '(' <值参数表> ')'                                  |
| <值参数表>             | <表达式> {,<表达式>} \| <空>                                 |
| <语句列>               | {<语句>}                                                     |
| <读语句>               | scanf'(' <标识符> {, <标识符>}')' *例：scanf(a,b,c,d)*       |
| <写语句>               | printf '(' <字符串> , <表达式> ')' \| printf '(' <字符串> ')' \| printf '(' <表达式> ')   *例：printf("abc", 1+3), printf("abc"), printf(a+1)* |
| <返回语句>             | return ['(' <表达式> ')'] *例：return , return a+b, return 0* |



## 二、词法分析

### 1. 保留字表：

| 保留字 | 宏名   | 宏体 |
| ------ | ------ | ---- |
| int    | INT    | 1    |
| char   | CHAR   | 2    |
| void   | VOID   | 3    |
| const  | CONST  | 4    |
| main   | MAIN   | 5    |
| if     | IF     | 6    |
| else   | ELSE   | 7    |
| while  | WHILE  | 8    |
| switch | SWITCH | 9    |
| case   | CASE   | 10   |
| scanf  | SCANF  | 11   |
| printf | PRINTF | 12   |
| return | RETURN | 13   |

### 2. 特殊符号表：

| 特殊符号 | 宏名     | 宏体 |
| -------- | -------- | ---- |
| 标识符   | ID       | 14   |
| >        | BIGTH    | 15   |
| <        | SMALLTH  | 16   |
| \>=      | NOTSMALL | 17   |
| <=       | NOTBIG   | 18   |
| !=       | NOTEQUL  | 19   |
| ==       | DOUEQUL  | 20   |
| =        | EQUAL    | 21   |
| +        | PLUS     | 22   |
| -        | MINUS    | 23   |
| *        | MULT     | 24   |
| /        | DIV      | 25   |
| ,        | COMMA    | 26   |
| {        | LBPAREN  | 27   |
| }        | RBPAREN  | 28   |
| [        | LMPAREN  | 29   |
| ]        | RMPAREN  | 30   |
| (        | LPAREN   | 31   |
| )        | RPAREN   | 32   |
| :        | COLON    | 33   |
| ;        | SEMIC    | 34   |
| 字符串   | STRING   | 35   |
| 整数     | NUMBER   | 36   |
| 单个字符 | CHARSYM  | 37   |
| '        | SQUOTE   | 38   |
| "        | DQUOTE   | 39   |

### 3. token的定义

```cpp
typedef struct 
{
    string name;    // token名
    int nameid;     // token的id
    string id;      // 文件中的单词
    int value;      // 值
} Token;
```

### 4. 词法分析自动机

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gf70w7it2lj31180u0q4a.jpg)



## 三、语法分析

### 1. 递归下降程序



### 2. 符号表设计

在进行语法分析，语法错误检查时，还需要检查当前使用的标识符是否已经定义





## 四、中间代码生成

四元式设计：

| 原始语句                 | op     | a       | b    | result |
| ------------------------ | ------ | ------- | ---- | ------ |
| const int a = 98         | const  | int     | 98   | a      |
| const char b = 'a'       | const  | char    | 97   | b      |
| void sun()               | funct  |         |      | sun    |
| int fun()                | func   | int     |      | fun    |
| fun(int n)               | para   | int     |      | n      |
| n == a                   | ==     | n       | a    |        |
| n != a                   | !=     | n       | a    |        |
| n >= a                   | \>=    | n       | a    |        |
| n <= a                   | <=     | n       | a    |        |
| n > a                    | >      | n       | a    |        |
| n < a                    | <      | n       | a    |        |
| if(n == 1){ ...... }     | ==     | n       | 1    |        |
|                          |        |         |      |        |
|                          |        |         |      |        |
|                          |        |         |      |        |
|                          |        |         |      |        |
| return(1);               | reta   |         |      | 1      |
| return ;                 | ret    |         |      |        |
| fun(n-2)                 |        |         |      |        |
|                          |        |         |      |        |
|                          |        |         |      |        |
| printf("hello world\n"); | prtf   | string0 |      | string |
| void main()              | MAIN   |         |      | main   |
| int temp;                | int    |         |      | temp   |
| int num[5];              | int    | array   | 5    | num    |
| scanf(a);                | scanf  |         |      | a      |
| i = 0                    | =      | 0       |      | i      |
| num[i]=a;                | arrayl | a       | i    | num    |
| temp=num[j]              | array  | num     | j    | temp   |
|                          |        |         |      |        |
| while(i<5){......}       |        |         |      |        |
|                          |        |         |      |        |
|                          |        |         |      |        |
|                          |        |         |      |        |
| 函数末尾                 | end    | func    |      |        |



## 五、mips汇编生成



## 六、优化



## 七、过程中遇到的问题和解决方法

### 1. 词法分析中的问题

1. **问题描述**：扫描不是一个字符的token时，比如数字、关键字等，必须要扫描到空格或者其他非显示字符时才能停止，但是这个时候文件指针就已经指向了下一个字符，这时候很有可能跳过行末的换行符，导致记录行号出错。

   **解决方案**：扫描长字符时，扫描结束把文件指针后撤一格，由于我是先把文件读入到一个字符串里，所以模拟的文件指针回撤很方便。

   

2. **问题描述**：对于负数的识别，容易出错，比较麻烦。

   **解决方案**：把正负号和数字分开识别，只识别数字，正负数留在后期语法分析再判断。

3. 

   



